<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ripplit</title>
  <style>
    :root{
      --bg:#f6f8ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,.12);
      --shadow:0 14px 40px rgba(15,23,42,.10);
      --r:18px;
      --accent:#2563eb;
      --accent2:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(900px 500px at 20% 0%, rgba(37,99,235,.12), transparent 55%),
                  radial-gradient(900px 500px at 80% 10%, rgba(22,163,74,.10), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1050px; margin:0 auto; padding:22px 16px 70px}
    header{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      margin-bottom:14px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:42px; height:42px; border-radius:16px;
      background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(22,163,74,.85));
      box-shadow: var(--shadow);
    }
    h1{margin:0; font-size:18px}
    .sub{color:var(--muted); font-size:13px; margin-top:2px}
    .grid{display:grid; grid-template-columns: 1fr .95fr; gap:14px; margin-top:12px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;} }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    .cardBody{padding:16px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background: #f8fafc;
      font-size:12px;
      white-space:nowrap;
    }
    .balance{
      font-size:30px;
      font-weight:900;
      letter-spacing:-.02em;
    }
    .muted{color:var(--muted)}
    .row{display:flex; justify-content:space-between; gap:12px; align-items:center}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap}
    button{
      border:0;
      cursor:pointer;
      border-radius: 14px;
      padding:10px 12px;
      font-weight:800;
      transition: transform .04s ease, opacity .15s ease;
    }
    button:active{transform: translateY(1px)}
    .btn{background:#f1f5f9; color:var(--text); border:1px solid var(--border)}
    .btnPrimary{background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(37,99,235,.75)); color:white;}
    .btnGood{background: linear-gradient(135deg, rgba(22,163,74,.95), rgba(22,163,74,.75)); color:white;}
    .btnGhost{background:transparent; border:1px solid var(--border); color:var(--muted)}
    .tag{
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      color:var(--muted);
    }
    .statusP{background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.25); color:#8a5a00;}
    .statusF{background: rgba(22,163,74,.10); border-color: rgba(22,163,74,.25); color:#0b5f2a;}
    .statusE{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.25); color:#8a1010;}
    .contact{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius: 14px;
      background:#ffffff;
      margin-top:10px;
    }
    .contactLeft{display:flex; flex-direction:column; gap:2px}
    .contactName{font-weight:900}
    .contactDid{font-size:12px; color:var(--muted)}
    input[type="checkbox"]{width:18px; height:18px}
    .historyItem{
      padding:12px;
      border:1px solid var(--border);
      border-radius: 14px;
      background:#ffffff;
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      margin-bottom:10px;
    }
    .hTitle{font-weight:950}
    .hSmall{font-size:12px; color:var(--muted); margin-top:4px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Ripplit Wallet</h1>
        <div class="sub">GroupPay checkout</div>
      </div>
    </div>
    <div class="btnRow">
      <button class="btn" onclick="init()">Initialize Wallet</button>
      <button class="btnGhost" onclick="refreshAll()">Refresh</button>
    </div>
  </header>

  <div class="grid">
    <!-- Wallet + redirect prompt -->
    <div class="card">
      <div class="cardHeader">
        <div style="font-weight:950">Your wallet</div>
        <div class="pill">User: <b>Alice</b></div>
      </div>
      <div class="cardBody">
        <div class="row">
          <div>
            <div class="muted" style="font-size:13px">Balance</div>
            <div class="balance" id="bal">—</div>
          </div>
          <div class="pill" id="addrPill">Not initialized</div>
        </div>

        <div style="height:12px"></div>

        <div class="card" style="box-shadow:none; border-radius:14px;">
          <div class="cardHeader">
            <div style="font-weight:950">Payment request</div>
            <div class="tag" id="orderTag">No order</div>
          </div>
          <div class="cardBody">
            <div class="muted" style="font-size:13px">Order</div>
            <div style="font-weight:900" id="orderLine">—</div>
            <div class="muted" style="font-size:13px; margin-top:6px">Total</div>
            <div style="font-weight:950" id="totalLine">—</div>

            <div style="height:10px"></div>

            <div class="muted" style="font-size:13px">Choose co-payees</div>
            <div class="contact">
              <div class="contactLeft">
                <div class="contactName">Bob</div>
                <div class="contactDid">did:ripplit:bob</div>
              </div>
              <input type="checkbox" id="cbBob" checked />
            </div>
            <div class="contact">
              <div class="contactLeft">
                <div class="contactName">Chen</div>
                <div class="contactDid">did:ripplit:chen</div>
              </div>
              <input type="checkbox" id="cbChen" checked />
            </div>

            <div style="height:12px"></div>

            <div class="row">
              <div>
                <div class="muted" style="font-size:13px">Your share</div>
                <div style="font-weight:950" id="shareLine">—</div>
              </div>
              <button class="btnGood" onclick="proceed()" id="proceedBtn" disabled>Proceed with Payment</button>
            </div>

            <div class="muted" style="font-size:12px; margin-top:10px" id="hint">
              Initialize wallet first.
            </div>

            <div style="height:10px"></div>

            <div class="btnRow">
              <button class="btn" onclick="openCopayer('bob')">Open Bob wallet</button>
              <button class="btn" onclick="openCopayer('chen')">Open Chen wallet</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- History -->
    <div class="card">
      <div class="cardHeader">
        <div style="font-weight:950">Transaction history</div>
        <button class="btnGhost" onclick="loadHistory()">Refresh</button>
      </div>
      <div class="cardBody">
        <div id="history"></div>
        <div class="muted" id="emptyHist">No transactions yet.</div>
      </div>
    </div>
  </div>

</div>

<script>
const qs = new URLSearchParams(window.location.search);
const order_id = qs.get("order_id") || "";
const total_xrp = parseFloat(qs.get("total_xrp") || "0");
const return_url = qs.get("return_url") || "";
const item_label = "Marketplace order";

let inited = false;
let lastRequestId = null;

function fmtX(x){ return `${x.toFixed(2)} XRP`; }

function calcShare() {
  let n = 1; // alice
  if(document.getElementById("cbBob").checked) n++;
  if(document.getElementById("cbChen").checked) n++;
  return n ? (total_xrp / n) : total_xrp;
}

function setOrderInfo(){
  const tag = document.getElementById("orderTag");
  const orderLine = document.getElementById("orderLine");
  const totalLine = document.getElementById("totalLine");
  const shareLine = document.getElementById("shareLine");

  if(order_id){
    tag.textContent = order_id;
    orderLine.textContent = order_id;
    totalLine.textContent = fmtX(total_xrp);
    shareLine.textContent = fmtX(calcShare());
  } else {
    tag.textContent = "No order";
    orderLine.textContent = "Open via marketplace redirect";
    totalLine.textContent = "—";
    shareLine.textContent = "—";
  }
}

document.getElementById("cbBob").addEventListener("change", () => {
  document.getElementById("shareLine").textContent = fmtX(calcShare());
});
document.getElementById("cbChen").addEventListener("change", () => {
  document.getElementById("shareLine").textContent = fmtX(calcShare());
});

async function init(){
  const r = await fetch("/api/admin/init", { method:"POST" });
  const j = await r.json();
  inited = !j.error;
  await refreshBalance();
  document.getElementById("hint").textContent = "Ready.";
  document.getElementById("proceedBtn").disabled = !(inited && order_id);
  await loadHistory();
}

async function refreshBalance(){
  const r = await fetch("/api/wallet/balance/alice");
  const j = await r.json();
  if(j.error){
    document.getElementById("bal").textContent = "—";
    document.getElementById("addrPill").textContent = "Not initialized";
    return;
  }
  document.getElementById("bal").textContent = fmtX(j.balance_xrp);
  document.getElementById("addrPill").textContent = j.address.slice(0,6) + "…" + j.address.slice(-6);
}

async function proceed(){
  if(!order_id) return;
  if(!inited) return alert("Initialize wallet first.");

  const selected = [];
  if(document.getElementById("cbBob").checked) selected.push("bob");
  if(document.getElementById("cbChen").checked) selected.push("chen");
  if(selected.length === 0) return alert("Select at least one co-payee.");

  document.getElementById("proceedBtn").disabled = true;
  document.getElementById("hint").textContent = "Creating request and paying your share…";

  const body = {
    order_id,
    total_xrp,
    return_url,
    item_label,
    selected_payees: selected
  };

  const r = await fetch("/api/ripplit/start", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(body)
  });
  const j = await r.json();

  if(j.request?.request_id){
    lastRequestId = j.request.request_id;
    document.getElementById("hint").textContent = "Request created. Waiting for others to pay…";
  } else {
    document.getElementById("hint").textContent = "Failed to start.";
  }

  await refreshBalance();
  await loadHistory();
  document.getElementById("proceedBtn").disabled = false;
}

function statusChip(s){
  if(s === "FULFILLED") return `<span class="tag statusF">Fulfilled</span>`;
  if(s === "EXPIRED") return `<span class="tag statusE">Expired</span>`;
  return `<span class="tag statusP">Pending</span>`;
}

async function loadHistory(){
  const r = await fetch("/api/ripplit/history");
  const j = await r.json();
  const list = j.history || [];
  const el = document.getElementById("history");
  const empty = document.getElementById("emptyHist");

  if(list.length === 0){
    el.innerHTML = "";
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";
  el.innerHTML = list.map(h => `
    <div class="historyItem">
      <div>
        <div class="hTitle">${h.order_id}</div>
        <div class="hSmall">Total ${fmtX(h.total_xrp)}</div>
      </div>
      <div>${statusChip(h.status)}</div>
    </div>
  `).join("");
}

function openCopayer(user){
  window.open(`/static/copayer.html?user=${user}`, "_blank");
}

async function refreshAll(){
  setOrderInfo();
  await refreshBalance();
  await loadHistory();
  document.getElementById("proceedBtn").disabled = !(inited && order_id);
}

setOrderInfo();
refreshAll();
</script>
</body>
</html>
